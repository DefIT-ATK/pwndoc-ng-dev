<template>
  <div v-if="vulnerabilities.length > 0" class="q-mt-lg">
    <div class="row items-center q-mb-md">
      <div class="col">
        <div class="text-h6">{{ $t('toolIntegration.preview.title') }}</div>
        <div class="text-body2">
          {{ $t('toolIntegration.preview.description', { 
            unique: vulnerabilities.length,
            total: totalVulnerabilities 
          }) }}
        </div>
        <div class="text-caption text-grey-6 q-mt-xs">
          {{ $t('toolIntegration.preview.mergeInfo', { 
            unique: vulnerabilities.length,
            total: totalVulnerabilities 
          }) }}
        </div>
      </div>
      <div class="col-auto">
        <q-btn
          :label="$t('toolIntegration.preview.selectAll')"
          flat
          color="primary"
          size="sm"
          @click="selectAll"
        />
        <q-btn
          :label="$t('toolIntegration.preview.deselectAll')"
          flat
          color="primary"
          size="sm"
          @click="deselectAll"
        />
      </div>
    </div>
    
    <q-table
      :rows="vulnerabilities"
      :columns="previewColumns"
      row-key="title"
      :pagination="{ rowsPerPage: 100 }"
      dense
      selection="multiple"
      :selected="selected"
      @update:selected="updateSelected"
      class="vulnerability-table"
    >
      <template v-slot:body-cell-severity="props">
        <div class="text-center severity-cell">
          <q-badge
            :color="getSeverityColor(props.value)"
            :label="props.value"
            class="severity-badge"
            text-color="white"
          />
        </div>
      </template>
    </q-table>

    <!-- Import Button -->
    <div class="q-mt-md text-center">
      <q-btn
        :label="importButtonLabel"
        color="primary"
        :loading="importing"
        :disable="selected.length === 0 || !selectedAudit"
        size="lg"
        @click="onImport"
      >
        <template v-slot:loading>
          <q-spinner-facebook />
        </template>
      </q-btn>
    </div>
  </div>
</template>

<script>
import { defineComponent } from 'vue'
import { $t } from '@/boot/i18n'

export default defineComponent({
  name: 'VulnerabilityPreview',
  
  props: {
    vulnerabilities: {
      type: Array,
      required: true
    },
    selected: {
      type: Array,
      required: true
    },
    audits: {
      type: Array,
      required: true
    },
    selectedAudit: {
      type: String,
      default: null
    },
    importing: {
      type: Boolean,
      default: false
    },
    totalVulnerabilities: {
      type: Number,
      default: 0
    },
    importButtonLabel: {
      type: String,
      required: true
    }
  },
  
  emits: ['update:selected', 'import'],
  
  setup() {
    const previewColumns = [
      {
        name: 'title',
        label: $t('toolIntegration.preview.columns.title'),
        field: 'title',
        align: 'left',
        sortable: true
      },
      {
        name: 'severity',
        label: $t('toolIntegration.preview.columns.severity'),
        field: 'severity',
        align: 'center',
        sortable: true,
        sort: (a, b) => {
          const severityOrder = { 'Critical': 4, 'High': 3, 'Medium': 2, 'Low': 1, 'Info': 0 }
          return severityOrder[b] - severityOrder[a]
        }
      },
      {
        name: 'cvss',
        label: $t('toolIntegration.preview.columns.cvss'),
        field: 'cvssScore',
        align: 'center',
        sortable: true
      }
    ]
    
    const getSeverityColor = (severity) => {
      const colors = {
        'Critical': 'red',
        'High': 'orange',
        'Medium': 'yellow',
        'Low': 'green',
        'Info': 'blue'
      }
      return colors[severity] || 'grey'
    }
    
    return {
      previewColumns,
      getSeverityColor
    }
  },
  
  methods: {
    selectAll() {
      this.$emit('update:selected', [...this.vulnerabilities])
    },
    
    deselectAll() {
      this.$emit('update:selected', [])
    },
    
    updateSelected(newSelected) {
      this.$emit('update:selected', newSelected)
    },
    
    onImport() {
      this.$emit('import')
    }
  }
})
</script>

<style scoped>
.severity-badge {
  font-size: 0.75rem;
  padding: 4px 8px;
  min-width: 70px;
  text-align: center;
  font-weight: 500;
}

.severity-cell {
  background-color: #f5f5f5;
  width: 100%;
  padding: 4px;
}

/* Force the severity column to have grey background */
:deep(.vulnerability-table th:nth-child(2)) {
  background-color: #f5f5f5 !important;
}

:deep(.vulnerability-table td:nth-child(2)) {
  background-color: #f5f5f5 !important;
}
</style>
